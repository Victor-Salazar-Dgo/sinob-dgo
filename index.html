<script>

let datos = {};
let chart;
let subsistemaSeleccionado = null;
const tbody = document.querySelector("#tablaPlanteles tbody");

// CARGA AUTOMÃTICA DEL EXCEL
window.addEventListener("load", function(){
    fetch("datos.xlsx")
    .then(res => res.arrayBuffer())
    .then(data => {
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet,{defval:""});
        procesarDatosFlexible(json);
    })
    .catch(err => {
        console.error("Error cargando datos.xlsx", err);
    });
});

function procesarDatosFlexible(json){
    datos = {};
    json.forEach(r => {
        const claves = Object.keys(r);
        const colSubsistema = claves.find(c => c.toLowerCase().includes("subsistema"));
        const colPlantel = claves.find(c => c.toLowerCase().includes("plantel"));
        const colEstatus = claves.find(c => c.toLowerCase().includes("estatus") || c.toLowerCase().includes("estado"));
        if(!colSubsistema || !colPlantel || !colEstatus) return;

        const subsistema = r[colSubsistema];
        if(!datos[subsistema]) datos[subsistema] = [];
        datos[subsistema].push({plantel:r[colPlantel], estatus:r[colEstatus]});
    });

    crearBotones();
    actualizarTotales();
    actualizarGrafico();
}

function crearBotones(){
    const cont = document.getElementById("botonesSubsistemas");
    cont.innerHTML="";
    Object.keys(datos).forEach(s=>{
        let btn=document.createElement("button");
        btn.textContent=s;
        btn.onclick=()=>{
            subsistemaSeleccionado = s;
            mostrarPlanteles(s);
        };
        cont.appendChild(btn);
    });
}

function mostrarPlanteles(subsistema){
    tbody.innerHTML="";
    datos[subsistema].forEach(p=>{
        let clase="";
        if(p.estatus.toLowerCase().includes("concl")) clase="verde";
        else if(p.estatus.toLowerCase().includes("proceso")) clase="amarillo";
        else clase="rojo";

        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${p.plantel}</td><td class="${clase}">${p.estatus}</td>`;
        tbody.appendChild(tr);
    });
}

function actualizarTotales(){
    let concluidos=0, proceso=0, pendientes=0;
    Object.values(datos).flat().forEach(p=>{
        if(p.estatus.toLowerCase().includes("concl")) concluidos++;
        else if(p.estatus.toLowerCase().includes("proceso")) proceso++;
        else pendientes++;
    });
    document.getElementById("cConcluidos").textContent=concluidos;
    document.getElementById("cProceso").textContent=proceso;
    document.getElementById("cPendientes").textContent=pendientes;
}

function actualizarGrafico(){
    let concluidos=0, proceso=0, pendientes=0;
    Object.values(datos).flat().forEach(p=>{
        if(p.estatus.toLowerCase().includes("concl")) concluidos++;
        else if(p.estatus.toLowerCase().includes("proceso")) proceso++;
        else pendientes++;
    });

    const ctx=document.getElementById('grafico');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
        type:'bar',
        data:{
            labels:['Concluidos','En proceso','Pendientes'],
            datasets:[{data:[concluidos,proceso,pendientes]}]
        },
        options:{responsive:false,plugins:{legend:{display:false}}}
    });
}

function exportarExcelSeleccionado(){
    if(!subsistemaSeleccionado){
        alert("Seleccione primero un subsistema");
        return;
    }
    let csv="Subsistema,Plantel,Estatus\n";
    datos[subsistemaSeleccionado].forEach(p=>{
        csv+=`${subsistemaSeleccionado},${p.plantel},${p.estatus}\n`;
    });
    let blob=new Blob([csv],{type:"text/csv"});
    let link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="reporte_"+subsistemaSeleccionado+".csv";
    link.click();
}

</script>
